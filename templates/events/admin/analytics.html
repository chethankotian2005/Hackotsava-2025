{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="analytics-page">
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 10px;">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                Analytics Dashboard
            </h1>
            <p class="page-subtitle">Detailed insights and statistics for Hackotsava 2025</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3>{{ total_events }}</h3>
                    <p>Total Events</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                        <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3>{{ total_photos }}</h3>
                    <p>Total Photos</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3>{{ total_faces }}</h3>
                    <p>Faces Detected</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3>{{ total_searches }}</h3>
                    <p>Face Searches</p>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="charts-row">
            <!-- Top Events Chart -->
            <div class="chart-card">
                <h3 class="chart-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
                    </svg>
                    Top Events by Photos
                </h3>
                <div class="chart-content">
                    {% if top_events %}
                        {% for event in top_events %}
                        <div class="chart-bar-item">
                            <div class="bar-label">
                                <span class="event-name">{{ event.name }}</span>
                                <span class="event-count">{{ event.photo_count }} photos</span>
                            </div>
                            <div class="bar-track">
                                <div class="bar-fill" data-width="{{ event.percentage|floatformat:0 }}"></div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="empty-state-text">No events with photos yet</p>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Searches -->
            <div class="chart-card">
                <h3 class="chart-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                    Recent Face Searches
                </h3>
                <div class="list-content">
                    {% if recent_searches %}
                        {% for search in recent_searches %}
                        <div class="list-item">
                            <div class="list-item-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                </svg>
                            </div>
                            <div class="list-item-content">
                                <div class="list-item-title">
                                    {{ search.event.name }}
                                    {% if search.matches_found > 0 %}
                                        <span class="badge badge-success">{{ search.matches_found }} match{{ search.matches_found|pluralize:"es" }}</span>
                                    {% else %}
                                        <span class="badge badge-muted">No matches</span>
                                    {% endif %}
                                </div>
                                <div class="list-item-meta">
                                    {{ search.searched_at|timesince }} ago
                                    {% if search.user %}
                                        by <strong>{{ search.user.username }}</strong>
                                    {% else %}
                                        by <strong>Guest</strong>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="empty-state-text">No face searches yet</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Top Searchers Table -->
        <div class="table-card">
            <h3 class="table-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                </svg>
                Most Active Users
            </h3>
            <div class="table-responsive">
                {% if top_searchers %}
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>User</th>
                                <th>Email</th>
                                <th>Total Searches</th>
                                <th>Matches Found</th>
                                <th>Last Search</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for searcher in top_searchers %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <div class="user-cell">
                                        <div class="user-avatar">
                                            {{ searcher.user__username|slice:":1"|upper }}
                                        </div>
                                        <strong>{{ searcher.user__username|default:"Guest User" }}</strong>
                                    </div>
                                </td>
                                <td>{{ searcher.user__email|default:"N/A" }}</td>
                                <td>
                                    <span class="badge badge-primary">{{ searcher.search_count }}</span>
                                </td>
                                <td>
                                    <span class="badge badge-success">{{ searcher.total_matches }}</span>
                                </td>
                                <td class="text-muted">{{ searcher.last_search|timesince }} ago</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="empty-state-text">No user search activity yet</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.analytics-page {
    padding: 3rem 0;
    min-height: 60vh;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin: 2rem 0;
}

.stat-card {
    background: var(--card-bg);
    border: 1px solid var(--border-purple);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);
    border-color: var(--primary-purple);
}

.stat-icon {
    width: 64px;
    height: 64px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.stat-content h3 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-light);
    margin: 0 0 0.25rem 0;
}

.stat-content p {
    color: var(--text-muted);
    margin: 0;
    font-size: 0.95rem;
}

.charts-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
    margin: 2rem 0;
}

.chart-card, .table-card {
    background: var(--card-bg);
    border: 1px solid var(--border-purple);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
}

.chart-title, .table-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: var(--primary-purple);
    font-size: 1.25rem;
    margin: 0 0 1.5rem 0;
}

.chart-title svg, .table-title svg {
    color: var(--primary-purple);
}

.chart-bar-item {
    margin-bottom: 1.5rem;
}

.chart-bar-item:last-child {
    margin-bottom: 0;
}

.bar-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.event-name {
    color: var(--text-light);
    font-weight: 500;
}

.event-count {
    color: var(--text-muted);
    font-size: 0.9rem;
}

.bar-track {
    height: 8px;
    background: rgba(139, 92, 246, 0.1);
    border-radius: 4px;
    overflow: hidden;
}

.bar-fill {
    height: 100%;
    border-radius: 4px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transition: width 0.5s ease;
}

.list-content {
    max-height: 400px;
    overflow-y: auto;
}

.list-item {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: rgba(139, 92, 246, 0.05);
    border: 1px solid var(--border-purple);
    border-radius: var(--radius-md);
    margin-bottom: 0.75rem;
    transition: all 0.3s ease;
}

.list-item:hover {
    background: rgba(139, 92, 246, 0.1);
    border-color: var(--primary-purple);
}

.list-item-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.list-item-icon svg {
    color: white;
}

.list-item-content {
    flex: 1;
}

.list-item-title {
    color: var(--text-light);
    font-weight: 500;
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.list-item-meta {
    color: var(--text-muted);
    font-size: 0.875rem;
}

.badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
}

.badge-success {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
}

.badge-muted {
    background: rgba(107, 114, 128, 0.2);
    color: #6b7280;
}

.badge-primary {
    background: rgba(139, 92, 246, 0.2);
    color: var(--primary-purple);
}

.table-card {
    margin: 2rem 0;
}

.table-responsive {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead {
    background: rgba(139, 92, 246, 0.1);
}

.data-table th {
    padding: 1rem;
    text-align: left;
    color: var(--primary-purple);
    font-weight: 600;
    border-bottom: 2px solid var(--border-purple);
}

.data-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border-purple);
    color: var(--text-gray);
}

.data-table tbody tr:hover {
    background: rgba(139, 92, 246, 0.05);
}

.user-cell {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.user-avatar {
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.875rem;
}

.text-muted {
    color: var(--text-muted);
}

.empty-state-text {
    color: var(--text-muted);
    text-align: center;
    padding: 2rem;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .charts-row {
        grid-template-columns: 1fr;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .data-table th,
    .data-table td {
        padding: 0.75rem 0.5rem;
    }
}
</style>

<script>
// Set bar chart widths from data attributes to avoid CSS linter warnings
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.bar-fill[data-width]').forEach(function(bar) {
        bar.style.width = bar.getAttribute('data-width') + '%';
    });
});
</script>
{% endblock %}
